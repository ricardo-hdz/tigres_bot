'use strict';

var ApiBuilder = require('claudia-api-builder');
var fbSetup = require('./facebook/setup');
var slackSetup = require('./slack/setup');
var telegramSetup = require('./telegram/setup');
var skypeSetup = require('./skype/setup');
var fbTemplate = require('./facebook/format-message');
var slackTemplate = require('./slack/format-message');
var slackDelayedReply = require('./slack/delayed-reply');

let logError = function (err) {
  console.error(err);
};

module.exports = function botBuilder(messageHandler, optionalLogError) {
  logError = optionalLogError || logError;

  var api = new ApiBuilder(),
    messageHandlerPromise = function (message, originalApiBuilderRequest) {
      return Promise.resolve(message).then(message => messageHandler(message, originalApiBuilderRequest));
    };

  api.get('/', () => 'Ok');

  fbSetup(api, messageHandlerPromise, logError);
  slackSetup(api, messageHandlerPromise, logError);
  telegramSetup(api, messageHandlerPromise, logError);
  skypeSetup(api, messageHandlerPromise, logError);

  return api;
};

module.exports.fbTemplate = fbTemplate;
module.exports.slackTemplate = slackTemplate;
module.exports.slackDelayedReply = slackDelayedReply;
